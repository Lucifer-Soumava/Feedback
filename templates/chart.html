<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feedback Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container dashboard">
    <h2>📊 Feedback Dashboard</h2>

    <!-- Dark Mode Toggle -->
    <div class="toggle-container">
      <label class="switch">
        <input type="checkbox" id="darkToggle" />
        <span class="slider round"></span>
      </label>
      <span style="margin-left:8px;">Dark Mode</span>
    </div>

    <!-- Info Cards -->
    <div class="cards">
      <div class="card">
        <h3>📝 Total Feedbacks</h3>
        <p id="totalVal">0</p>
      </div>
      <div class="card">
        <h3>⭐ Average Rating</h3>
        <p id="avgVal">{{ initial_avg }}</p>
      </div>
      <div class="card">
        <h3>🕒 Latest Feedback</h3>
        <p id="latestVal">—</p>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-box">
        <h3>Rating Distribution</h3>
        <canvas id="ratingChart"></canvas>
      </div>
    </div>

    <div class="center-actions" style="margin-top:16px;">
      <a href="/download-feedback"><button>📥 Download Feedback (CSV)</button></a>
      <a href="/logout"><button>🚪 Logout</button></a>
    </div>
  </div>

  <script>
    const pieCtx = document.getElementById("ratingChart").getContext("2d");

    // Pie Chart
    const pieChart = new Chart(pieCtx, {
      type: "pie",
      data: {
        labels: ["1 ⭐", "2 ⭐", "3 ⭐", "4 ⭐", "5 ⭐"],
        datasets: [{
          data: [0,0,0,0,0],
          backgroundColor: ["#ff4d4d","#ff944d","#ffd11a","#99e600","#4dff88"]
        }]
      },
      options: { responsive: true, plugins:{legend:{position:"bottom"}} }
    });

    // Refresh data
    async function refreshDashboard() {
      const res = await fetch("/chart-data");
      if (!res.ok) return;
      const { buckets, average, total, latest } = await res.json();

      // Update pie
      pieChart.data.datasets[0].data = buckets;
      pieChart.update();

      // Update cards
      document.getElementById("avgVal").textContent = average;
      document.getElementById("totalVal").textContent = total;
      document.getElementById("latestVal").textContent = latest || "—";
    }

    refreshDashboard();
    setInterval(refreshDashboard, 3000);

    // Dark Mode
    const toggle = document.getElementById("darkToggle");
    toggle.addEventListener("change", () => {
      document.body.classList.toggle("dark", toggle.checked);
    });
  </script>
</body>
</html>
